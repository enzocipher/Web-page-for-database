<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Búsqueda de Personas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="icon" type="image/png" href="{{ url_for('static', filename='brisket.jpg') }}">
</head>
<body>
<div class="container">
    <div class="logo-container">
        <img src="{{ url_for('static', filename='brisket.jpg') }}" alt="Brisket Logo" class="logo-img">
        <h2>Base de datos Policía Arequipa</h2>
    </div>
    <div class="row mb-3">
        <div class="col-md-8 offset-md-2">
            <div class="input-group shadow-sm mb-2">
                <input type="text" id="nombreInput" class="form-control" placeholder="Buscar por nombre">
                <button class="btn btn-primary" onclick="buscar('listar_por_nombres')">Buscar Nombre</button>
            </div>
            <div class="input-group shadow-sm">
                <input type="text" id="unidadInput" class="form-control" placeholder="Buscar por unidad">
                <button class="btn btn-info" onclick="buscar('listar_por_unidad')">Buscar Unidad</button>
            </div>
        </div>
    </div>
    <div id="tablaContainer" class="table-responsive"></div>
    <nav>
        <ul class="pagination" id="paginacion"></ul>
    </nav>
</div>
<footer>
    &copy; 2025 Policía Arequipa &mdash; Todos los derechos reservados.
</footer>
<script>
let resultados = [];
let paginaActual = 1;
const filasPorPagina = 20;

function buscar(funcion) {
    let valor = '';
    if (funcion === 'listar_por_nombres') {
        valor = document.getElementById('nombreInput').value;
    } else if (funcion === 'listar_por_unidad') {
        valor = document.getElementById('unidadInput').value;
    }
    fetch('/api/funcion/funcion', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            nombre_funcion: funcion,
            parametros: [valor]
        })
    })
    .then(res => res.json())
    .then(data => {
        resultados = data;
        paginaActual = 1;
        mostrarTabla();
        mostrarPaginacion();
    })
    .catch(err => {
        document.getElementById('tablaContainer').innerHTML = 
            `<div class="alert alert-danger">Error: ${err}</div>`;
    });
}

function mostrarTabla() {
    if (!resultados.length) {
        document.getElementById('tablaContainer').innerHTML = 
            '<div class="alert alert-info mt-3">No hay resultados.</div>';
        document.getElementById('paginacion').innerHTML = '';
        return;
    }
    const inicio = (paginaActual - 1) * filasPorPagina;
    const fin = inicio + filasPorPagina;
    const pagina = resultados.slice(inicio, fin);

    let tabla = '<table class="table table-striped table-bordered shadow-sm">';
    tabla += '<thead><tr>';
    Object.keys(pagina[0]).forEach(col => {
        tabla += `<th>${col}</th>`;
    });
    tabla += '</tr></thead><tbody>';
    pagina.forEach(row => {
        tabla += '<tr>';
        Object.values(row).forEach(val => {
            tabla += `<td>${val}</td>`;
        });
        tabla += '</tr>';
    });
    tabla += '</tbody></table>';
    document.getElementById('tablaContainer').innerHTML = tabla;
}

function mostrarPaginacion() {
    const totalPaginas = Math.ceil(resultados.length / filasPorPagina);
    let paginacion = '';

    if (totalPaginas <= 1) {
        document.getElementById('paginacion').innerHTML = '';
        return;
    }

    // Mostrar máximo 5 páginas alrededor de la actual
    let start = Math.max(1, paginaActual - 2);
    let end = Math.min(totalPaginas, paginaActual + 2);

    // Siempre mostrar la primera página
    if (start > 1) {
        paginacion += `
            <li class="page-item"><a class="page-link" href="#" onclick="cambiarPagina(1);return false;">1</a></li>
        `;
        if (start > 2) {
            paginacion += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
    }

    for (let i = start; i <= end; i++) {
        paginacion += `
            <li class="page-item ${i === paginaActual ? 'active' : ''}">
                <a class="page-link" href="#" onclick="cambiarPagina(${i});return false;">${i}</a>
            </li>`;
    }

    // Siempre mostrar la última página
    if (end < totalPaginas) {
        if (end < totalPaginas - 1) {
            paginacion += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
        }
        paginacion += `
            <li class="page-item"><a class="page-link" href="#" onclick="cambiarPagina(${totalPaginas});return false;">${totalPaginas}</a></li>
        `;
    }

    document.getElementById('paginacion').innerHTML = paginacion;
}

function cambiarPagina(num) {
    paginaActual = num;
    mostrarTabla();
    mostrarPaginacion();
}
</script>
</body>
</html>